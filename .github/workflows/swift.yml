name: Swift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Get latest iOS simulator destination
      id: simulator
      run: |
        # 사용 가능한 시뮬레이터 목록에서 최신 모델+OS 선택
        LINE=$(xcrun simctl list devices available |
          grep -E 'iPhone|iPad' |
          grep -v "unavailable" |
          sort -t, -k2 -r |
          head -1)
        
        # 예시 LINE: "iPhone 16 Pro (18.1) [UUID]"
        DEVICE_NAME=$(echo "$LINE" | awk -F ' \(' '{print $1}')
        OS_VERSION=$(echo "$LINE" | awk -F '[()]' '{print $2}')

        DEST="platform=iOS Simulator,OS=$OS_VERSION,name=$DEVICE_NAME"
        echo "DESTINATION=$DEST" >> $GITHUB_ENV
        echo "Selected destination: $DEST"

    - name: Build
      run: xcodebuild build-for-testing -scheme "SwiftComponents-Package" -destination "$DESTINATION"

    - name: Run tests
      run: xcodebuild test -scheme "SwiftComponents-Package" -destination "$DESTINATION"
