name: Swift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Get latest iOS simulator destination
      id: simulator
      run: |
        LINE=$(xcrun simctl list devices available |
          grep -E 'iPhone|iPad' |
          grep -v "unavailable" |
          sort -t, -k2 -r |
          head -1)
    
        DEVICE_NAME=$(echo "$LINE" | sed -E 's/ \([0-9.]+\).*//')
        OS_VERSION=$(echo "$LINE" | sed -E 's/.*\(([0-9.]+)\).*/\1/')
    
        DEST="platform=iOS Simulator,OS=$OS_VERSION,name=$DEVICE_NAME"
        echo "DESTINATION=$DEST" >> $GITHUB_ENV
        echo "Selected destination: $DEST"

    - name: Build
      run: xcodebuild build-for-testing -scheme "SwiftComponents-Package" -destination "$DESTINATION"

    - name: Run tests
      run: xcodebuild test -scheme "SwiftComponents-Package" -destination "$DESTINATION"
